# Milestone - Production Docker Compose
#
# This runs the FastAPI backend which serves both API and React frontend.
# The React frontend is pre-built and deployed to the public/ folder.
#
# Usage:
#   docker compose up -d
#
# Access: http://your-server:8485/

services:
  milestone:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: milestone
    restart: unless-stopped
    ports:
      - "8485:8485"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - .env
    environment:
      - PORT=8485
      - TZ=Europe/Zurich
    volumes:
      - /mnt/user/appdata/milestone/uploads:/app/uploads
      - ./public:/app/public:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8485/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 256m
    networks:
      - milestone-net
      - guac-net

networks:
  milestone-net:
    driver: bridge
  guac-net:
    external: true
