# Milestone - Fresh Install with External/Managed PostgreSQL
#
# For corporate environments with a managed PostgreSQL server
# (AWS RDS, Azure Database, on-premise, etc.)
#
# Setup:
#   1. Copy .env.example to .env
#   2. Set DB_HOST, DB_PORT, PG_ADMIN_USER, PG_ADMIN_PASSWORD to your
#      managed PostgreSQL server credentials
#   3. Run: docker compose -f docker-compose.external-db.yml up -d
#
# The app will:
#   1. Wait for PostgreSQL readiness at DB_HOST:DB_PORT
#   2. Auto-create application databases and schema (requires PG_ADMIN_* creds)
#   3. Seed default admin user
#   4. Start the application
#
# Required .env variables:
#   DB_HOST=your-postgres-host.example.com
#   DB_PORT=5432
#   PG_ADMIN_USER=postgres           # Needs CREATEDB/CREATEROLE privileges
#   PG_ADMIN_PASSWORD=your-password
#   SECRET_KEY=<generate with: python -c "import secrets; print(secrets.token_hex(32))">
#   SESSION_SECRET=<generate with: python -c "import secrets; print(secrets.token_hex(32))">
#
# Access: http://localhost:8485/

services:
  milestone:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: milestone
    restart: unless-stopped
    ports:
      - "8485:8485"
    env_file:
      - .env
    environment:
      - PORT=8485
      - TZ=${TZ:-Europe/Zurich}
      # Auto-initialization (creates DBs on first run)
      - AUTO_INIT_DB=true
      - INIT_ADMIN_EMAIL=${INIT_ADMIN_EMAIL:-admin@milestone.local}
      - INIT_ADMIN_PASSWORD=${INIT_ADMIN_PASSWORD:-}
    volumes:
      - uploads:/app/uploads
      - ./public:/app/public:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8485/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 256m
    networks:
      - milestone-net

volumes:
  uploads:

networks:
  milestone-net:
    driver: bridge
