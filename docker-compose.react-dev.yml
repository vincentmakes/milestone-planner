# Milestone with React Frontend - Unraid Development Setup
# 
# This compose file runs:
# - milestone-api: FastAPI backend on port 8485
# - milestone-react: React frontend on port 3000 (dev server with hot reload)
#
# Usage:
#   docker-compose -f docker-compose.react-dev.yml up -d
#
# Access the React frontend at: http://your-unraid-ip:3000
# The React dev server proxies API requests to the backend

version: '3.8'

services:
  # FastAPI Backend
  milestone-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: milestone-api
    restart: unless-stopped
    ports:
      - "8485:8485"
    env_file:
      - .env
    environment:
      - PORT=8485
      - TZ=Europe/Zurich
    volumes:
      - /mnt/user/appdata/milestone/uploads:/app/uploads
      - ./public:/app/public:ro
      # Note: Don't mount ./app as it would override the built-in db/, models/, etc.
      # Instead, rebuild the image with: docker-compose up -d --build
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8485/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - milestone-net
      - guac-net

  # React Frontend (Development Server)
  milestone-react-dev:
    image: node:20-alpine
    container_name: milestone-react-dev
    restart: unless-stopped
    working_dir: /app
    ports:
      - "3333:3333"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - TZ=Europe/Zurich
      # Explicitly disable proxy for all requests
      - HTTP_PROXY=
      - HTTPS_PROXY=
      - http_proxy=
      - https_proxy=
      - NO_PROXY=*
      - no_proxy=*
    volumes:
      # Mount the frontend source code
      - ./frontend:/app
      # Use named volume for node_modules to avoid platform issues
      - react_node_modules:/app/node_modules
    command: >
      sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 3333"
    depends_on:
      milestone-api:
        condition: service_healthy
    networks:
      - milestone-net

networks:
  milestone-net:
    driver: bridge
  guac-net:
    external: true

volumes:
  react_node_modules:
