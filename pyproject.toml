[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "auto"
filterwarnings = [
    "ignore::DeprecationWarning",
]
addopts = [
    "-v",
    "--strict-markers",
    "--tb=short",
]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests requiring database or external services",
]

[tool.black]
line-length = 100
target-version = ["py311"]

[tool.isort]
profile = "black"
line_length = 100

[tool.ruff]
line-length = 100
target-version = "py311"

[tool.ruff.lint]
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
    "B",   # flake8-bugbear
    "UP",  # pyupgrade
]
ignore = [
    "E501", # line too long (handled by black)
    "B008", # function call in default argument (false positive for FastAPI Depends)
]

[tool.mypy]
python_version = "3.11"
warn_return_any = false
warn_unused_configs = true
ignore_missing_imports = true
disable_error_code = [
    "no-any-return",   # SQLAlchemy column values are typed as Any
    "valid-type",      # SQLAlchemy 2.0 DeclarativeBase not recognized by mypy
    "arg-type",        # Column[T] passed where T expected (legacy Column vs Mapped)
    "assignment",      # Assigning T to Column[T] (same root cause)
    "return-value",    # Returning ColumnElement[bool] where bool expected
    "index",           # Column[str] used as dict key
]

# Module overrides for non-Column-related issues in existing code.
# These ADD to the global disable_error_code list.
[[tool.mypy.overrides]]
module = "app.routers.mpp_import"
disable_error_code = ["union-attr", "var-annotated", "import-untyped"]

[[tool.mypy.overrides]]
module = "app.routers.admin_organizations"
disable_error_code = ["call-arg"]  # snake_case vs camelCase kwargs with populate_by_name

[[tool.mypy.overrides]]
module = "app.routers.projects"
disable_error_code = ["attr-defined"]  # __table__.delete()/update() not recognized

[[tool.mypy.overrides]]
module = "app.routers.export"
disable_error_code = ["attr-defined"]  # Relationship attrs not visible to mypy

[[tool.mypy.overrides]]
module = "app.routers.sites"
disable_error_code = ["attr-defined"]  # Query result unpacking

[[tool.mypy.overrides]]
module = "app.routers.predefined_phases"
disable_error_code = ["attr-defined"]  # Schema alias mismatch

[[tool.mypy.overrides]]
module = "app.routers.staff"
disable_error_code = ["misc"]  # List comprehension type inference

[[tool.mypy.overrides]]
module = "app.routers.auth"
disable_error_code = ["var-annotated"]  # Module-level sentinel

[[tool.mypy.overrides]]
module = "app.websocket.handler"
disable_error_code = ["attr-defined", "call-overload"]  # Session vs User attrs, sessionmaker overload

[[tool.mypy.overrides]]
module = "app.middleware.tenant"
disable_error_code = ["attr-defined"]  # Scope MutableMapping.copy()
